<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yapper</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --imessage-blue: linear-gradient(180deg, #00D2FF 0%, #007AFF 100%);
            --bg-main: #ffffff;
            --text-dark: #000000;
            --text-gray: #8E8E93;
            --bubble-received: #E9E9EB;
            --border: #C6C6C8;
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        [data-theme="dark"] {
            --bg-main: #000000; --text-dark: #ffffff; --text-gray: #98989D;
            --bubble-received: #1C1C1E; --border: #38383A;
        }

        /* Prevent Text Highlighting/Copying */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        input { -webkit-user-select: text; user-select: text; }

        body, html { margin: 0; padding: 0; height: 100dvh; font-family: var(--ios-font); background: var(--bg-main); color: var(--text-dark); overflow: hidden; }
        
        .view { display: none; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: var(--bg-main); }
        .header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid var(--border); height: 64px; }

        /* Profile Modal */
        #profile-modal {
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%;
            background: var(--bg-main); border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.3); transition: bottom 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            z-index: 3000; padding: 20px; display: flex; flex-direction: column; align-items: center;
        }
        #profile-modal.active { bottom: 0; }
        .modal-handle { width: 40px; height: 5px; background: var(--border); border-radius: 10px; margin-bottom: 20px; }

        /* Reaction Pop-up */
        #reaction-menu {
            position: fixed; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 10px 18px; display: none; gap: 12px; z-index: 2000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); border: 0.5px solid var(--border);
            transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #reaction-menu.active { display: flex; transform: scale(1); }
        .react-opt { font-size: 26px; cursor: pointer; transition: transform 0.1s; }

        /* Messages */
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; }
        .msg-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; width: 100%; position: relative; }
        .msg-row.sent { flex-direction: row-reverse; }
        .pc-trigger { opacity: 0; cursor: pointer; color: var(--text-gray); font-size: 18px; transition: 0.2s; padding: 5px; }
        .msg-row:hover .pc-trigger { opacity: 1; }

        .msg { max-width: 75%; padding: 10px 16px; font-size: 16px; border-radius: 20px; line-height: 1.3; position: relative; cursor: pointer; }
        .sent .msg { background: var(--imessage-blue); color: white; border-bottom-right-radius: 4px; }
        .received .msg { background: var(--bubble-received); color: var(--text-dark); border-bottom-left-radius: 4px; }
        .reaction-badge { position: absolute; bottom: -10px; right: 10px; background: white; border-radius: 15px; padding: 2px 6px; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 0.5px solid #ddd; color: #000; }

        /* Auth/Inputs */
        .auth-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: var(--text-dark); margin-bottom: 10px; font-size: 16px; }
        .blue-btn { width: 100%; background: #007AFF; color: white; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body data-theme="dark">

    <div id="reaction-menu">
        <span class="react-opt" onclick="applyReaction('üòÇ')">üòÇ</span>
        <span class="react-opt" onclick="applyReaction('üò¢')">üò¢</span>
        <span class="react-opt" onclick="applyReaction('üòÆ')">üòÆ</span>
        <span class="react-opt" onclick="applyReaction('üò°')">üò°</span>
        <span class="react-opt" onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    </div>

    <div id="profile-modal">
        <div class="modal-handle"></div>
        <h2 style="margin-bottom: 20px;">Profile Settings</h2>
        <input type="text" id="edit-nick" class="auth-input" placeholder="Nickname">
        <input type="text" id="edit-avatar" class="auth-input" placeholder="Avatar Emoji (e.g. üòé)">
        <button onclick="saveProfile()" class="blue-btn" style="margin-top:10px;">Save Changes</button>
        <button onclick="handleLogout()" style="margin-top:30px; background:none; border:none; color:#FF3B30; font-weight:600; font-size:16px;">Logout</button>
        <button onclick="toggleProfile(false)" style="margin-top:15px; background:none; border:none; color:#007AFF;">Cancel</button>
    </div>

    <div id="auth-view" class="view">
        <div style="padding:40px; text-align:center; flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h1 style="font-size:42px; letter-spacing:-2px; margin-bottom:40px;">Yapper</h1>
            <input type="email" id="email" class="auth-input" placeholder="Email">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <button onclick="handleLogin()" class="blue-btn">Log In</button>
        </div>
    </div>

    <div id="home-view" class="view">
        <div class="header">
            <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:22px;">üåì</button>
            <div style="font-weight:700; font-size:24px;">Messages</div>
            <button onclick="toggleProfile(true)" style="background:none; border:none; color:#007AFF; font-size:17px; font-weight:500;">Edit</button>
        </div>
        <div id="friend-list"></div>
    </div>

    <div id="chat-view" class="view">
        <div class="header">
            <button id="btn-back" onclick="goHome()" style="background:none; border:none; color:#007AFF; font-size:17px;">‚Äπ Back</button>
            <div id="chat-target-name" style="font-weight:600;">Contact</div>
            <div style="width:40px;"></div>
        </div>
        <div id="messages" onclick="closeMenu()"></div>
        <div style="padding:10px 12px 34px; display:flex; align-items:center; gap:10px; border-top:0.5px solid var(--border);">
            <div style="flex:1; border:0.5px solid var(--border); border-radius:25px; padding:8px 16px;">
                <input type="text" id="msg-input" style="width:100%; border:none; background:transparent; outline:none; color:var(--text-dark); font-size:16px;" placeholder="Yapper">
            </div>
            <button id="btn-send" onclick="sendMessage()" style="background:#007AFF; border:none; width:32px; height:32px; border-radius:50%; color:white; font-weight:bold;">‚Üë</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyB98LWEjfYaG_wbkMkwo0QJ4ch8VhQO-IA", authDomain: "messengerapp-dcccc.firebaseapp.com", projectId: "messengerapp-dcccc", storageBucket: "messengerapp-dcccc.firebasestorage.app", messagingSenderId: "255835922798", appId: "1:255835922798:web:d9293fc275ae2b18fa617f" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        let activeChatId = null, selectedMsgId = null, pressTimer = null;

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, user => {
            if (user) { switchView('home-view'); loadFriends(); } 
            else { switchView('auth-view'); }
        });

        window.handleLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("Login Failed: " + err.message));
        };

        window.handleLogout = () => { signOut(auth); toggleProfile(false); };

        // --- PROFILE LOGIC ---
        window.toggleProfile = (show) => {
            const modal = document.getElementById('profile-modal');
            if(show) {
                modal.classList.add('active');
                getDoc(doc(db, "users", auth.currentUser.uid)).then(s => {
                    document.getElementById('edit-nick').value = s.data().nickname || "";
                    document.getElementById('edit-avatar').value = s.data().avatar || "üë§";
                });
            } else { modal.classList.remove('active'); }
        };

        window.saveProfile = async () => {
            const n = document.getElementById('edit-nick').value;
            const a = document.getElementById('edit-avatar').value;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { nickname: n, avatar: a });
            toggleProfile(false);
        };

        // --- MESSAGING & REACTIONS ---
        function loadFriends() {
            onSnapshot(collection(db, "users", auth.currentUser.uid, "friends"), snap => {
                const list = document.getElementById('friend-list'); list.innerHTML = '';
                snap.forEach(d => {
                    onSnapshot(doc(db, "users", d.data().uid), fSnap => {
                        const f = fSnap.data();
                        const row = document.createElement('div');
                        row.style = "padding:15px; border-bottom:0.5px solid var(--border); display:flex; align-items:center; gap:12px; cursor:pointer;";
                        row.innerHTML = `<div style="font-size:24px;">${f.avatar || 'üë§'}</div><div><div style="font-weight:600;">${f.nickname}</div><div style="font-size:12px; color:var(--text-gray);">${f.status==='online'?'Active Now':'Offline'}</div></div>`;
                        row.onclick = () => openChat(f, [auth.currentUser.uid, d.data().uid].sort().join('_'));
                        list.appendChild(row);
                    });
                });
            });
        }

        function openChat(friend, roomId) {
            activeChatId = roomId; switchView('chat-view');
            document.getElementById('chat-target-name').innerText = friend.nickname;
            onSnapshot(query(collection(db, "chats", roomId, "messages"), orderBy("timestamp", "asc")), snap => {
                const div = document.getElementById('messages'); div.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data(); const isSent = m.sender === auth.currentUser.uid;
                    const container = document.createElement('div'); container.className = `msg-row ${isSent?'sent':'received'}`;
                    container.innerHTML = `
                        <div class="pc-trigger" onclick="openMenu('${d.id}', event)">‚ò∫</div>
                        <div class="msg" onmousedown="startPress('${d.id}', event)" onmouseup="endPress()" ontouchstart="startPress('${d.id}', event)" ontouchend="endPress()">
                            ${m.text}${m.reaction ? `<div class="reaction-badge">${m.reaction}</div>` : ''}
                        </div>`;
                    div.appendChild(container);
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        window.sendMessage = () => {
            const i = document.getElementById('msg-input');
            if(i.value.trim() && activeChatId) {
                addDoc(collection(db, "chats", activeChatId, "messages"), { text: i.value, sender: auth.currentUser.uid, timestamp: serverTimestamp() });
                i.value = '';
            }
        };

        // UI Helpers
        window.switchView = (id) => { document.querySelectorAll('.view').forEach(v => v.style.display='none'); document.getElementById(id).style.display='flex'; };
        window.goHome = () => { activeChatId = null; switchView('home-view'); };
        window.toggleDarkMode = () => { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); };
        window.startPress = (id, e) => { pressTimer = setTimeout(() => openMenu(id, e), 500); };
        window.endPress = () => clearTimeout(pressTimer);
        window.openMenu = (id, e) => {
            selectedMsgId = id; const menu = document.getElementById('reaction-menu');
            const pos = e.touches ? e.touches[0] : e;
            menu.style.top = (pos.clientY - 70) + "px";
            menu.style.left = Math.max(10, Math.min(window.innerWidth - 220, pos.clientX - 100)) + "px";
            menu.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(40);
        };
        window.closeMenu = () => document.getElementById('reaction-menu').classList.remove('active');
        window.applyReaction = async (emoji) => {
            if(selectedMsgId && activeChatId) {
                await updateDoc(doc(db, "chats", activeChatId, "messages", selectedMsgId), { reaction: emoji });
                closeMenu();
            }
        };
    </script>
</body>
</html>
