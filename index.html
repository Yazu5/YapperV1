<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yapper</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --imessage-blue: linear-gradient(180deg, #00D2FF 0%, #007AFF 100%);
            --bg-main: #ffffff; --text-dark: #000000; --text-gray: #8E8E93;
            --bubble-received: #E9E9EB; --border: #C6C6C8;
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        [data-theme="dark"] {
            --bg-main: #000000; --text-dark: #ffffff; --text-gray: #98989D;
            --bubble-received: #1C1C1E; --border: #38383A;
        }

        /* Essential Reset */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        input { -webkit-user-select: text; user-select: text; }
        body, html { margin: 0; padding: 0; height: 100dvh; font-family: var(--ios-font); background: var(--bg-main); color: var(--text-dark); overflow: hidden; }
        
        /* Views */
        .view { display: none; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: var(--bg-main); }
        .header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid var(--border); height: 64px; }

        /* Search & Lists */
        .search-bar { width: calc(100% - 32px); margin: 10px 16px; padding: 10px; border-radius: 10px; border: none; background: var(--bubble-received); color: var(--text-dark); outline: none; }
        .card { background: var(--bubble-received); margin: 5px 16px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        
        /* Message UI */
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; }
        .msg-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; position: relative; }
        .msg-row.sent { flex-direction: row-reverse; }
        .msg { max-width: 75%; padding: 10px 16px; font-size: 16px; border-radius: 20px; line-height: 1.3; position: relative; }
        .sent .msg { background: var(--imessage-blue); color: white; border-bottom-right-radius: 4px; }
        .received .msg { background: var(--bubble-received); color: var(--text-dark); border-bottom-left-radius: 4px; }
        
        .pc-trigger { opacity: 0; cursor: pointer; color: var(--text-gray); font-size: 18px; transition: 0.2s; padding: 5px; }
        .msg-row:hover .pc-trigger { opacity: 1; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background: #34C759; box-shadow: 0 0 5px #34C759; }
        .offline { background: var(--text-gray); }

        /* Modals & Menus */
        #reaction-menu { 
            position: fixed; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); 
            border-radius: 20px; padding: 10px; display: none; flex-direction: column; gap: 10px; 
            z-index: 2000; box-shadow: 0 8px 30px rgba(0,0,0,0.3); transform: scale(0); transition: 0.2s; 
        }
        #reaction-menu.active { display: flex; transform: scale(1); }
        .emoji-row { display: flex; gap: 12px; font-size: 24px; border-bottom: 0.5px solid #ddd; padding-bottom: 8px; }
        .delete-btn { color: #FF3B30; font-weight: 600; text-align: center; padding-top: 5px; cursor: pointer; }

        #profile-modal { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%; background: var(--bg-main); border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.5); transition: 0.4s; z-index: 3000; padding: 20px; text-align: center; }
        #profile-modal.active { bottom: 0; }
        
        .blue-btn { background: #007AFF; color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        .reaction-badge { position: absolute; bottom: -8px; right: 10px; background: white; border-radius: 12px; padding: 1px 5px; font-size: 12px; border: 0.5px solid #ddd; color: black; }
    </style>
</head>
<body data-theme="dark">

    <div id="reaction-menu">
        <div class="emoji-row">
            <span onclick="applyReaction('üòÇ')">üòÇ</span><span onclick="applyReaction('üò¢')">üò¢</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span><span onclick="applyReaction('üò°')">üò°</span>
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        </div>
        <div id="delete-opt" class="delete-btn" onclick="unsendMessage()">Unsend</div>
    </div>

    <div id="auth-view" class="view" style="display:flex;">
        <div style="padding:40px; flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
            <h1 id="auth-title" style="font-size: 48px; letter-spacing: -2px;">Yapper</h1>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:15px; margin-bottom:10px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text-dark);">
            <input type="password" id="password" placeholder="Password" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text-dark);">
            <button onclick="handleAuth()" class="blue-btn">Log In</button>
            <p onclick="toggleAuthMode()" id="toggle-text" style="color:#007AFF; margin-top:25px; cursor:pointer;">New to Yapper? Sign Up</p>
        </div>
    </div>

    <div id="home-view" class="view">
        <div class="header">
            <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:22px;">üåì</button>
            <div style="font-weight:700; font-size:24px;">Messages</div>
            <button onclick="toggleProfile(true)" style="background:none; border:none; color:#007AFF; font-weight:500;">Edit</button>
        </div>
        <input type="text" id="search-bar" class="search-bar" placeholder="Search nickname to add..." oninput="handleSearch()">
        <div id="requests-list"></div>
        <div id="friend-list" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="chat-view" class="view">
        <div class="header">
            <button onclick="goHome()" style="background:none; border:none; color:#007AFF; font-size:17px;">‚Äπ Back</button>
            <div id="chat-target-name" style="font-weight:600;">...</div>
            <button onclick="blockUser()" style="background:none; border:none; color:#FF3B30; font-size:14px;">Block</button>
        </div>
        <div id="messages" onclick="closeMenu()"></div>
        <div style="padding:10px 12px 34px; display:flex; gap:10px; border-top:0.5px solid var(--border);">
            <input type="text" id="msg-input" style="flex:1; border:none; background:var(--bubble-received); color:var(--text-dark); padding:10px 15px; border-radius:20px; outline:none;" placeholder="Yapper">
            <button onclick="sendMessage()" style="background:#007AFF; color:white; border:none; width:36px; height:36px; border-radius:50%; font-weight:bold;">‚Üë</button>
        </div>
    </div>

    <div id="profile-modal">
        <div style="width:40px; height:5px; background:var(--border); border-radius:10px; margin: 0 auto 20px;"></div>
        <h2 style="margin-bottom:25px;">Profile Settings</h2>
        <input type="text" id="edit-nick" placeholder="New Nickname" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text-dark);">
        <button onclick="saveProfile()" class="blue-btn">Save Changes</button>
        <button onclick="handleLogout()" style="margin-top:30px; color:#FF3B30; background:none; border:none; font-weight:600; font-size:16px; width:100%;">Logout</button>
        <button onclick="toggleProfile(false)" style="margin-top:15px; color:#007AFF; background:none; border:none; width:100%;">Cancel</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, setDoc, getDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyB98LWEjfYaG_wbkMkwo0QJ4ch8VhQO-IA", authDomain: "messengerapp-dcccc.firebaseapp.com", projectId: "messengerapp-dcccc", storageBucket: "messengerapp-dcccc.firebasestorage.app", messagingSenderId: "255835922798", appId: "1:255835922798:web:d9293fc275ae2b18fa617f" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        let activeChatId = null, selectedMsgId = null, isSignUp = false, currentFriendId = null, pressTimer;

        onAuthStateChanged(auth, user => {
            if (user) { switchView('home-view'); loadHome(); updateStatus('online'); } 
            else { switchView('auth-view'); }
        });

        // Auth Logic
        window.handleAuth = () => {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            if(isSignUp) { createUserWithEmailAndPassword(auth, e, p).then(c => setDoc(doc(db, "users", c.user.uid), { nickname: e.split('@')[0], status: 'online', uid: c.user.uid, blocked: [] })); } 
            else { signInWithEmailAndPassword(auth, e, p).catch(a => alert("Error: " + a.message)); }
        };
        window.toggleAuthMode = () => { isSignUp = !isSignUp; document.getElementById('auth-title').innerText = isSignUp ? "Join Yapper" : "Yapper"; document.getElementById('toggle-text').innerText = isSignUp ? "Have an account? Log In" : "New to Yapper? Sign Up"; };

        // Home Logic
        function loadHome() {
            // Pending Requests
            onSnapshot(collection(db, "users", auth.currentUser.uid, "requests"), snap => {
                const div = document.getElementById('requests-list'); div.innerHTML = '';
                snap.forEach(async d => {
                    const u = (await getDoc(doc(db, "users", d.id))).data();
                    div.innerHTML += `<div class="card"><span>Req: <b>${u.nickname}</b></span><button class="blue-btn" style="width:auto; padding:5px 15px;" onclick="acceptFriend('${d.id}')">Accept</button></div>`;
                });
            });
            // Friend List
            onSnapshot(collection(db, "users", auth.currentUser.uid, "friends"), snap => {
                const list = document.getElementById('friend-list'); list.innerHTML = '';
                snap.forEach(async d => {
                    onSnapshot(doc(db, "users", d.id), fDoc => {
                        const f = fDoc.data();
                        const row = document.createElement('div');
                        row.style = "padding:16px; display:flex; align-items:center; border-bottom:0.5px solid var(--border); cursor:pointer;";
                        row.innerHTML = `<div class="status-dot ${f.status}"></div><div style="font-weight:600;">${f.nickname}</div>`;
                        row.onclick = () => openChat(f);
                        list.appendChild(row);
                    });
                });
            });
        }

        window.handleSearch = () => {
            const term = document.getElementById('search-bar').value.toLowerCase();
            if(term.length < 2) return;
            onSnapshot(collection(db, "users"), snap => {
                snap.forEach(d => {
                    if(d.data().nickname.toLowerCase() === term && d.id !== auth.currentUser.uid) {
                        const div = document.getElementById('requests-list');
                        div.innerHTML = `<div class="card"><span>Found: ${d.data().nickname}</span><button class="blue-btn" style="width:auto; padding:5px 15px;" onclick="sendRequest('${d.id}')">Add</button></div>`;
                    }
                });
            });
        };

        window.sendRequest = async (id) => { await setDoc(doc(db, "users", id, "requests", auth.currentUser.uid), { from: auth.currentUser.uid }); alert("Request Sent!"); };
        window.acceptFriend = async (id) => {
            await setDoc(doc(db, "users", auth.currentUser.uid, "friends", id), { id });
            await setDoc(doc(db, "users", id, "friends", auth.currentUser.uid), { id });
            await deleteDoc(doc(db, "users", auth.currentUser.uid, "requests", id));
        };

        // Chat & Unsend
        function openChat(f) {
            currentFriendId = f.uid; activeChatId = [auth.currentUser.uid, f.uid].sort().join('_');
            switchView('chat-view'); document.getElementById('chat-target-name').innerText = f.nickname;
            onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("timestamp", "asc")), snap => {
                const div = document.getElementById('messages'); div.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data(); const isSent = m.sender === auth.currentUser.uid;
                    div.innerHTML += `<div class="msg-row ${isSent?'sent':'received'}">
                        <div class="pc-trigger" onclick="openMenu('${d.id}', event, ${isSent})">‚ò∫</div>
                        <div class="msg" onmousedown="handleStart('${d.id}', event, ${isSent})" ontouchstart="handleStart('${d.id}', event, ${isSent})" onmouseup="handleEnd()" ontouchend="handleEnd()">
                            ${m.text}${m.reaction ? `<div class="reaction-badge">${m.reaction}</div>` : ''}
                        </div></div>`;
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        window.handleStart = (id, e, isSent) => { selectedMsgId = id; pressTimer = setTimeout(() => openMenu(id, e, isSent), 500); };
        window.handleEnd = () => clearTimeout(pressTimer);
        window.openMenu = (id, e, isSent) => {
            selectedMsgId = id; const menu = document.getElementById('reaction-menu');
            const y = e.clientY || (e.touches ? e.touches[0].clientY : 100);
            menu.style.top = (y - 90) + "px"; menu.style.left = "40px"; menu.classList.add('active');
            document.getElementById('delete-opt').style.display = isSent ? 'block' : 'none';
        };

        window.unsendMessage = async () => { if(confirm("Unsend for everyone?")) { await deleteDoc(doc(db, "chats", activeChatId, "messages", selectedMsgId)); closeMenu(); } };
        window.applyReaction = async (emoji) => { await updateDoc(doc(db, "chats", activeChatId, "messages", selectedMsgId), { reaction: emoji }); closeMenu(); };

        window.sendMessage = () => {
            const i = document.getElementById('msg-input');
            if(i.value) { addDoc(collection(db, "chats", activeChatId, "messages"), { text: i.value, sender: auth.currentUser.uid, timestamp: serverTimestamp() }); i.value = ''; }
        };

        // Block & Settings
        window.blockUser = async () => { if(confirm("Block this user?")) { await updateDoc(doc(db, "users", auth.currentUser.uid), { blocked: arrayUnion(currentFriendId) }); goHome(); } };
        window.saveProfile = async () => { await updateDoc(doc(db, "users", auth.currentUser.uid), { nickname: document.getElementById('edit-nick').value }); toggleProfile(false); };
        
        // Utils
        window.switchView = (id) => { document.querySelectorAll('.view').forEach(v => v.style.display='none'); document.getElementById(id).style.display='flex'; };
        window.goHome = () => switchView('home-view');
        window.closeMenu = () => document.getElementById('reaction-menu').classList.remove('active');
        window.toggleDarkMode = () => { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); };
        window.toggleProfile = (s) => document.getElementById('profile-modal').classList.toggle('active', s);
        window.updateStatus = (s) => auth.currentUser && updateDoc(doc(db, "users", auth.currentUser.uid), { status: s });
        window.handleLogout = () => updateStatus('offline').then(() => signOut(auth));
    </script>
</body>
</html>
